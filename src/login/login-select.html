<link rel="import"
      href="../../bower_components/polymer/polymer.html">
<link rel="import"
      href="../../bower_components/paper-input/paper-input.html">
<link rel="import"
      href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import"
      href="../../bower_components/paper-button/paper-button.html">

<script src="/bower_components/moment/moment.js"></script>
<script src="/bower_components/moment-timezone/moment-timezone.js"></script>
<link rel="import"
      href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import"
      href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import"
      href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/f-jwt-decode/f-jwt-decode.html">

<dom-module id="login-select">

    <template>
        <style></style>

        <dom-if if="{{decoded.UserId}}">
            <template>
                <iron-ajax auto
                           on-response="_setTerminal"
                           headers="{{headers}}"
                           last-response="{{user}}"
                           url="/v1/users/{{decoded.UserId}}"></iron-ajax>
            </template>
        </dom-if>
        <dom-if if="{{storeId}}">
            <template>
                <!--Terminal Acquirer-->
                <iron-ajax auto last-response="{{terminals}}"
                           headers="{{headers}}"
                           url="/v1/terminals/?query=StoreId:{{storeId}},UserId__isnull:true">
                </iron-ajax>
            </template>
        </dom-if>
        <dom-if if="{{reset}}">
            <template>
                <!--Logouts the Terminal-->
                <iron-ajax auto
                           headers="{{headers}}"
                           last-response="{{terminals}}"
                           url="/v1/terminals/empty/?logout=true"></iron-ajax>
            </template>
        </dom-if>

        <app-localstorage-document key="terminalId" data="{{terminalId}}"></app-localstorage-document>
        <app-localstorage-document key="storeId" data="{{storeId}}"></app-localstorage-document>


        <app-detail token-object="{{tokenObject}}" headers="{{headers}}"></app-detail>
        <f-jwt-decode token="{{tokenObject.token}}" value="{{decoded}}"></f-jwt-decode>


        <paper-dialog
                id="terminalBox"
                modal
                always-on-top
                restore-focus-on-close
                auto-fit-on-attach>
            <div>
                <paper-dropdown-menu label="Child ">
                    <paper-listbox
                            slot="dropdown-content" selected="{{storeId}}"
                            attr-for-selected="data-id">
                        <template is="dom-repeat" items="{{user.Stores}}" as="store">
                            <paper-item data-id="{{store.Id}}">{{store.StoreName}} - {{store.Address}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu label="Child ">
                    <paper-listbox
                            slot="dropdown-content" selected="{{terminalId}}"
                            attr-for-selected="data-id">
                        <template is="dom-repeat" items="{{terminals}}" as="terminal">
                            <paper-item data-id="{{terminal.Id}}">{{terminal.Machine}}-{{terminal.Printer}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-button on-click="_fix">Okay</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        class LoginSelect extends Polymer.Element {
            static get is() {
                return "login-select"
            }

            static get properties() {
                return {
                    reset: {
                        Type: Boolean,
                        value: null,
                        reflectToAttribute: true,
                        notify: true,
                    },
                    decoded: {
                        type: Object,
                        value: null,
                    },
                    terId: {
                        Type: Number,
                        value: null,
                        observer: "_selectTerminal"
                    },
                    terminalId: {
                        Type: Number,
                        value: null,
                        reflectToAttribute: true,
                        notify: true,
                    },
                    terminal: {
                        Type: Object,
                        value: {
                            UserId: {Id: null},
                        }
                    },
                    terminal_logged: {
                        Type: Object,
                        value: {
                            Id: 0,
                        }
                    }
                };
            }

            static get observers() {
                return ['_setUser(decoded.*)',
                    '_reset(reset)']
            }

            constructor() {
                super();
            }

            _setTerminal() {
                console.log(this.terminalId);
                if (!this.storeId || !this.terminalId)
                    this.$.terminalBox.open();
            }

            _reset() {
                if (this.reset) {
                    this.terminalId = 0;
                    this.reset = false;
                }
            }

            _fix() {
                if (this.terminalId && this.storeId){
                    console.log(this.terminalId)
                    this.$.terminalBox.close();
                }
            }
        }
        window.customElements.define(LoginSelect.is, LoginSelect);

    </script>

</dom-module>
