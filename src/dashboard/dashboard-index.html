<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import"
      href="../../bower_components/polymer/polymer.html">

<link rel="import"
      href="./product-data-table.html">

<dom-module id="dashboard-index">

    <template>

        <style>
            :host {
                display: block;
                /*padding: 10px;*/
            }


        </style>


        <!-- .columns -->
        <div class="columns">
            <template is="dom-if" if="{{!_isset(productIdentifier)}}">
                <iron-a11y-keys id="a11y" keys="1 2 3 4 5 6 7 8 9" target="[[target]]"
                                on-keys-down="_setBill"></iron-a11y-keys>
            </template>
            <!-- .column -->
            <div class="column">

                <product-data-table id="productdatatable"
                                    url="/v1/sales?query=BillId.Id:{{currentBill}}&limit=100&sortby=Id&order=desc"
                                    bill="{{bill}}"
                                    cold='["Pcode","PName","]'
                                    cols='{"InventoryId.ProductId.ProductCode":"PCode" ,"InventoryId.ProductId.Name":"Name","UnitPrice__currency":"Price","Units__number":"Qty","InventoryId.InventoryScale[0].ScaleId.Unit":"Unit","Total__currency":"Total","Discount__currency":"Discount","Amount__currency":"Net"}'
                                    editable='["Units","UnitPrice"]'
                                    refresh="{{refresh}}"
                                    id-row="Id"
                                    product-in="{{productList.0}}"
                                    product-list="{{productList}}"
                                    inventory-list="{{inventoryList}}"
                                    quantity-focus="{{quantityFocus}}"
                                    new-product="{{productIdentifier}}"
                                    quantity="{{quantity}}"
                                    get-url="/v1/sales/:id:/"
                                    post-url="/v1/sales/sqlput/:id:/"
                                    delete-url="/v1/sales/:id:/">
                </product-data-table>

            </div>
            <div class="column is-half">

                Bill Details {{_computeCurrency(bill.NetTotal)}} {{_computeCurrency(bill.Discount)}}
                {{_computeCurrency(bill.GrossTotal)}} {{_computeCurrency(bill.Cost)}} {{_computeCurrency(bill.Balance)}}

            </div>
            <!--.column-->
            <!--.column-->
        </div>
        <iron-ajax content-type="application/json"
                   id="createRequest"
                   method="POST"
                   last-response="{{createResult}}"></iron-ajax>
        <iron-ajax auto
                   content-type="application/json"
                   method="get"
                   debounce-duration="500"
                   id="billRequest"
                   url="/v1/bills/payable?refresh={{refresh}}"
                   last-response="{{bills}}">
        </iron-ajax>

        <iron-ajax content-type="application/json"
                   method="post"
                   debounce-duration="200"
                   id="createBill"
                   body="{{billBody}}"
                   on-response="_refreshBill"
                   url="/v1/bills/">
        </iron-ajax>
        <iron-ajax url="/v1/products/bill/?{{searchInput}}"
                   auto
                   debounce-duration="50"
                   on-response="_singleProduct"
                   last-response="{{productList}}">
        </iron-ajax>
        <iron-ajax id="inventoryRequest"
                   url="/v1/inventories?query=ProductId:{{productList.0.Id}}&limit=100"
                   on-response="_putRecord"
                   last-response="{{inventoryList}}">
        </iron-ajax>
        <paper-input hidden
                     id="product_identifier"
                     value="{{productIdentifier}}"
                     autofocus>
        </paper-input>
        <template is="dom-if"
                  if="{{_hasMany(productList)}}">
            <iron-a11y-keys id="a11y"
                            keys="ctrl+q ctrl+w ctrl+e ctrl+r ctrl+t ctrl+y ctrl+u ctrl+i ctrl+o ctrl+p ctrl+[ ctrl+]"
                            target="[[target]]" on-keys-pressed="_shortcutProduct"></iron-a11y-keys>
        </template>
        <template is="dom-if"
                  if="{{_hasMany(inventoryList)}}">
            <iron-a11y-keys id="a11y"
                            keys="ctrl+q ctrl+w ctrl+e ctrl+r ctrl+t ctrl+y ctrl+u ctrl+i ctrl+o ctrl+p ctrl+[ ctrl+]"
                            target="[[target]]" on-keys-pressed="_shortcutInventory"></iron-a11y-keys>
        </template>
    </template>

    <script>
        class DashboardIndex extends Polymer.Element {
            static get is() {
                return "dashboard-index";
            }

            static get properties() {
                return {

                    productIdentifier: {
                        type: String,
                        observer: '_searchInput'
                    },
                    bills: {
                        type: Object,
                        observer: '_setLastBill'
                    },
                    invId: {
                        type: Number,
                        observer: '_inventoryWatcher'
                    },
                    currentBill: {
                        type: Number,
                    },
                    refresh: {
                        type: Boolean,
                        value: false,
                        observer: '_refreshBill'
                    },
                    postUrl: {
                        type: "String",
                        value: "/v1/sales/:id:/"
                    },
                    target: {
                        type: Object,
                        value: function () {
                            return document.body;
                        }
                    },
                    productList: {
                        type: Object,
                        observer: '_singleProduct'
                    },
                    quantity: {
                        type: Number,
                        value: 0,
                        observer: '_quantityChanged'
                    },
                    quantityFocus: {
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true,
                        notify: true,
                    },
                    billBody: {
                        type: Object,
                        value: {
                            "CustomerId": null,
                            "Cost": 0,
                            "GrossTotal": 0,
                            "Discount": 0,
                            "NetTotal": 0,
                            "Balance": 0,
                            "CardPaid": 0,
                            "CashPaid": 0,
                            "UserId": {
                                "Id": 3,
                            },
                            "TerminalId": {
                                "Id": 3,
                            },
                        }
                    }

                };
            }

            constructor() {
                super();
            }

            _refreshBill() {

                this.refresh = false;
                if(!this.$.billRequest.activeRequests)
                this.$.billRequest.generateRequest();
            }

            _hasMany(arraylist) {
                if (arraylist.length <= 1) {
                    return false;
                }
                return true;
            }

            _getIndex(index) {
                return index + 1;
            }

            _selectProduct(event) {
                this.productIdentifier = this.productList[event.target.dataId].Name;
            }

            _searchInput() {

                if (!isNaN(this.productIdentifier)) {
                    this.searchInput = "query=Barcode:" + this.productIdentifier;
                } else {
                    this.searchInput = "query=Name:" + this.productIdentifier;
                }
            }

            _setLastBill() {
                if (!this.bills) {
                    this.$.createBill.generateRequest();
                } else {

                    this.currentBill = this.bills[0].Id;
                    this.bill = this.bills[0];
                }

            }

            _inventoryWatcher() {
                //                this.$.inventoryDialog.close();
                this.quantityFocus = true;
            }

            _quantityChanged() {
                if (this.quantity > 0 && this.invId)
                    this._putRecordPost(this.invId, parseFloat(this.quantity).toFixed(3));
            }

            _shortcutInventory(event) {
                a = ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p']
                key = a.indexOf(event.detail.keyboardEvent.key);
                if (key >= 0 && key <= 10) {
                    this.invId = this.inventoryList[key].Id;
                    this._inventoryWatcher();
                }
            }

            _shortcutProduct(event) {
                var a = ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p']
                var key = a.indexOf(event.detail.keyboardEvent.key);
                if (key >= 0 && key <= 10) {
                    this.productIdentifier = this.productList[key].Name;
                    this._singleProduct(this.productList)
                }

            }

            _setBill(event) {
                this.productIdentifier = "";

                if (event.target.dataId)
                    this.currentBill = event.target.dataId;
                console.log(this.currentBill)
                var key = parseInt(event.detail.keyboardEvent.key)
                if (key) {
                    if (key == 0)
                        key = 10;
                    this.currentBill = this.bills[key - 1].Id;
                }
                this.productIdentifier = "";
                this.quantity = "";
            }

            _singleProduct(productList) {
                if (productList.length === 1) {
                    this.$.inventoryRequest.generateRequest();
                }


            }

            _putRecord(event) {
                if ((this.productList[0].Id == event.target.dataId || this.inventoryList[0].ProductId.Id == this.productList[0].Id)) {
                    // delete invId;
                    var invId = null;
                    if (this.inventoryList.length == 1 && !event.target.dataId) {
                        invId = this.inventoryList[0].Id;
                    } else if (this.inventoryList.length > 1 && event.target.dataId) {
                        invId = event.target.dataId
                    }
                    if (invId) {
                        this.invId = invId;
                    }
                }
            }

            _putRecordPost(invId, units = 1.000) {

                var id = this.currentBill;

                var params = {}
                params["InventoryId"] = {};
                params["InventoryId"]["Id"] = invId;
                params["BillId"] = {};
                params["BillId"]["Id"] = id;
                params["Units"] = parseFloat(units);
                params["Discount"] = 0.0;
                if (this.postUrl) {
                    var postUrl = this.postUrl.replace(":id:/", '');
                    this.$.createRequest.url = postUrl;
                    this.$.createRequest.body = params;
                    this.$.createRequest.generateRequest();
                    this.$.productdatatable.refresh = true;
                    this.productList = [];
                    this.inventoryList = [];
                    this.productIdentifier = "";
                    this.$.product_identifier.focus();
                    //                    this.$.inventoryDialog.close();
                    this.quantity = "";
                    this.quantity = "";
                    this.quantity = "";
                    this.quantityFocus = false;

                }
            }

            _computeCurrency(x) {
                return parseFloat(x).toFixed(2);
            }

            _isset(value) {

                return value === "";
            }


        }
        window.customElements.define(DashboardIndex.is, DashboardIndex);
    </script>

</dom-module>
