<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="./product-data-table.html">

<link rel="stylesheet" href="../../bower_components/bulma/css/bulma.css" type="text/css" media="screen" title="no title"
      charset="utf-8">
<dom-module id="dashboard-index">

    <template>

        <style>
            :host {
                display: block;
                /*padding: 10px;*/
            }

            .productList {
                padding: 0;
            }


        </style>


        <!-- .columns -->
        <div class="columns">

            <template is="dom-if" if="{{!productIdentifier}}">
                <iron-a11y-keys id="a11y" keys="ctrl+1 ctrl+2" target="[[target]]"
                                on-keys-pressed="_setBill"></iron-a11y-keys>
            </template>
            <!-- .column -->
            <div class="column">

                <product-data-table
                        id="productdatatable"
                        url="/v1/sales?query=BillId.Id:{{currentBill}}&limit=100&sortby=Id&order=desc"
                        bill-id="{{currentBill}}"
                        cols='{"InventoryId.ProductId.ProductCode":"PCode" ,"InventoryId.ProductId.Name":"Product Name","InventoryId.InventoryScale[0].Price__currency":"Price","Units__number":"Qty","InventoryId.InventoryScale[0].ScaleId.Unit":"","Total__currency":"Total"}'
                        editable='{"Units"}'
                        refresh="{{refresh}}"
                        id-row="Id"
                        product-in="{{productList.0}}"
                        product-list="{{productList}}"
                        inventory-list="{{inventoryList}}"
                        quantity-focus="{{quantityFocus}}"
                        new-product="{{productIdentifier}}"
                        quantity="{{quantity}}"
                        get-url="/v1/sales/:id:/"
                        post-url="/v1/sales/:id:/"
                        delete-url="/v1/sales/:id:/">
                </product-data-table>

            </div>
            <div class="column is-half">
                Bill Details
                {{_computeCurrency(bill.NetTotal)}}
                {{_computeCurrency(bill.Discount)}}
                {{_computeCurrency(bill.GrossTotal)}}
                {{_computeCurrency(bill.Cost)}}

            </div>
            <!--.column-->
            <!--.column-->
        </div>
        <iron-ajax content-type="application/json" id="createRequest" method="POST"
                   last-response="{{createResult}}"></iron-ajax>
        <iron-ajax
                auto
                content-type="application/json"
                method="get"
                debounce-duration="200"
                id="billRequest"
                url="/v1/bills/payable?refresh={{refresh}}"
                last-response="{{bills}}">
        </iron-ajax>
        <iron-ajax url="/v1/products/bill/?{{searchInput}}"
                   auto
                   on-response="_singleProduct"
                   last-response="{{productList}}">
        </iron-ajax>
        <iron-ajax id="inventoryRequest" url="/v1/inventories?query=ProductId:{{productList.0.Id}}&limit=100"
                   on-response="_putRecord"
                   last-response="{{inventoryList}}">
        </iron-ajax>
        <paper-input hidden id="product_identifier" value="{{productIdentifier}}" autofocus>
        </paper-input>
        <template is="dom-if" if="{{_hasMany(productList)}}">
            <iron-a11y-keys id="a11y"
                            keys="ctrl+q ctrl+w ctrl+e ctrl+r ctrl+t ctrl+y ctrl+u ctrl+i ctrl+o ctrl+p ctrl+[ ctrl+]"
                            target="[[target]]" on-keys-pressed="_shortcutProduct"></iron-a11y-keys>
        </template>
        <template is="dom-if" if="{{_hasMany(inventoryList)}}">
            <iron-a11y-keys id="a11y"
                            keys="ctrl+q ctrl+w ctrl+e ctrl+r ctrl+t ctrl+y ctrl+u ctrl+i ctrl+o ctrl+p ctrl+[ ctrl+]"
                            target="[[target]]" on-keys-pressed="_shortcutInventory"></iron-a11y-keys>
        </template>
    </template>

    <script>

        Polymer({

            is: 'dashboard-index',
            properties: {

                productIdentifier: {
                    type: String,
                    observer: '_searchInput'
                },
                bills: {
                    type: Object,
                    observer: '_setLastBill'
                },
                invId: {
                    type: Number,
                    observer: '_inventoryWatcher'
                },
                refresh: {
                    type: Boolean,
                },
                currentBill: {
                    type: Number,
                },
                postUrl: {
                    type: "String",
                    value: "/v1/sales/:id:/"
                },
                target: {
                    type: Object,
                    value: function () {
                        return document.body;
                    }
                },
                productList: {
                    type: Object,
                    observer: '_singleProduct'
                },
                quantity: {
                    type: Number,
                    value: 0,
                    observer: '_quantityChanged'
                },
                quantityFocus: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_quantityWatcher'
                },

            },

            _hasMany: function (arraylist) {
                console.log(arraylist)
                if (arraylist.length <= 1) {
                    return false;
                }
                return true;
            },
            _getIndex: function (index) {
                return index + 1;
            },
            _selectProduct: function (event) {
                this.productIdentifier = this.productList[event.target.dataId].Name;
            },

            _searchInput: function () {
                input = this.productIdentifier;
                if (!isNaN(input)) {
                    this.searchInput = "query=Barcode:" + input;
                }
                else {
                    this.searchInput = "query=Name:" + input;
                }
            },
            _setLastBill: function () {
                console.log(this.bills);
                this.currentBill = this.bills[0].Id;
                this.bill = this.bills[0];
            },
            _inventoryWatcher: function () {
//                this.$.inventoryDialog.close();
                console.log('setout')
                this.quantityFocus = true;
            },
            _quantityChanged: function () {
                console.log(parseFloat(this.quantity).toFixed(3))
                console.log(this.invId)
                if (this.quantity > 0 && this.invId)
                    this._putRecordPost(this.invId, parseFloat(this.quantity).toFixed(3));
            },
            _shortcutInventory: function (event) {
                a = ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p']
                key = a.indexOf(event.detail.keyboardEvent.key);
                console.log(key)
                if (key >= 0 && key <= 10) {
                    this.invId = this.inventoryList[key].Id;
                    this._inventoryWatcher();
                }
                console.log(this.invId)
            },
            _shortcutProduct: function (event) {
                a = ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p']
                key = a.indexOf(event.detail.keyboardEvent.key);
                console.log(key)
                console.log(this.productList)
                if (key >= 0 && key <= 10) {
                    this.productIdentifier = this.productList[key].Name;
                    this._singleProduct(this.productList)
                }

            },
            _setBill: function (event) {

                console.log(event)
                if (event.target.dataId)
                    this.currentBill = event.target.dataId;
                if (key = parseInt(event.detail.keyboardEvent.key)) {
                    if (key == 0)
                        key = 10;
                    this.currentBill = this.bills[key - 1].Id;
                }
                this.productIdentifier = "";
                this.quantity = "";
            },
            _singleProduct: function (productList) {
                console.log(productList);
                if (productList.length === 1) {
                    this.$.inventoryRequest.generateRequest();
//                    this.$.inventoryDialog.open();
                    this.$.productDialog.close();
                }
            },
            _putRecord: function (event) {
                console.log(this.invId);
                console.log('testing')
                if ((this.productList[0].Id == event.target.dataId || this.inventoryList[0].ProductId.Id == this.productList[0].Id)) {
                    delete invId;
                    invId = null;
                    if (this.inventoryList.length == 1 && !event.target.dataId) {
                        invId = this.inventoryList[0].Id;
                    } else if (this.inventoryList.length > 1 && event.target.dataId) {
                        invId = event.target.dataId
                    }
                    if (invId) {
                        this.invId = invId;
                    }
                }
            },
            _putRecordPost: function (invId, units=1.000) {
                params = {};
                id = this.currentBill;
//                this.$.billRequest.generateRequest();

                params["InventoryId"] = {};
                params["InventoryId"]["Id"] = invId;
                params["BillId"] = {};
                params["BillId"]["Id"] = id;
                params["Units"] = parseFloat(units);
                params["Discount"] = 0.0;
                console.log(params);
                if (this.postUrl) {
                    postUrl = this.postUrl.replace(":id:/", '');
                    this.$.createRequest.url = postUrl;
                    this.$.createRequest.body = params;
                    this.$.createRequest.generateRequest();
                    this.$.productdatatable.refresh = true;
                    this.productList = [];
                    this.inventoryList = [];
                    this.productIdentifier = "";
                    this.$.product_identifier.focus();
//                    this.$.inventoryDialog.close();
                    this.quantity = "";
                    this.quantity = "";
                    this.quantity = "";
                    this.quantityFocus = false;
                    this.refresh = true;
                    console.log("posted");
                }
            },
            _computeCurrency: function (x) {
                return parseFloat(x).toFixed(2);
            },
            _isset: function (value) {

                return value === "";
            }


        });

    </script>

</dom-module>
