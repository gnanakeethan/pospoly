<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import"
    href="../../bower_components/polymer/polymer.html">
<link rel="import"
    href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import"
    href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<dom-module id="product-data-table">

    <template>
        <style>
            :host {
                display: block;
                clear: both;
                float: none;
            }

            * {
                font-family: "Noto Mono";
                font-weight: 500;
            }

            table {
                border: 0px solid #fff !important;
            }

            tr {
                background: #ccc;
            }

            th {
                font-size: 12px;
                color: rgba(0, 0, 0, .54);
                @apply(--paper-font-common-nowrap);
                padding: 5px;
                vertical-align: middle;
                font-weight: 900;
                height: 30px;
                /*transform: translate(0,0) rotate(270deg);*/
            }

            tr {
                height: 40px;
                vertical-align: middle;
            }

            td {
                font-size: 13px;
                margin: 0;
                padding-left: 5px;
                vertical-align: middle;
                color: rgba(0, 0, 0, .67);
            }

            tr.alternate:hover td {
                background: #777;
                color: #fff;
            }

            tr.alternate:nth-child(odd) {
                background: #ccc;
                color: #000;
            }

            tr.alternate:nth-child(even) {
                background: #ddd;
                color: #000;
            }

            td.table__Units__number__class {
                width: 30px;
            }

            input.table__Units__number__class {
                background: rgba(255, 255, 255, 0.4);
                width: 25px;
                border: none;
            }

            td.table__Total__currency__class {
                width: 70px;
            }

        </style>

        <iron-ajax
                id="mainRequest"
                debounce-duration="100"
                auto url="{{url}}&refresh={{refresh}}"
                last-response="{{data}}"></iron-ajax>

        <iron-ajax id="deleteRequest" method="DELETE"></iron-ajax>
        <iron-ajax content-type="application/json" id="editRequest" method="PUT"
                   debounce-duration="300"
                   last-response="{{editResult}}"></iron-ajax>

        <iron-a11y-keys id="a11y" keys="enter" target="[[target]]" on-keys-pressed="onEnter"></iron-a11y-keys>
        <iron-a11y-keys id="a11y" keys="a b c d e f g h i j k l m n o p q r s t u v w x y z" target="[[target]]"
                        on-keys-pressed="onRandom"></iron-a11y-keys>
        <table>
            <thead>
            <tr class="alternate">
                <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                    <th id="sortables" data-column="{{col}}" on-click="_sortToggle"
                        style$="text-align:{{_isCurrency(col)}}">{{_getColName(col)}}
                    </th>
                </template>
    <th></th>
    </tr>
    </thead>
    <tbody>
        <tr class="alternate">
            <td>
            </td>
            <td>
                <paper-input no-label-float
                    style=""
                    id="product_identifier"
                    value="{{newProduct}}"
                    autofocus>
                </paper-input>
            </td>
            <td></td>
            <td>
                <paper-input id="quantity_input"
                    no-label-float
                    on-blur="_setQuantity"
                    value="{{quantityInternal}}">
                </paper-input>
                {{quantity}}

            </td>
            <td></td>
            <td></td>
            <td></td>
        </tr>

        <template is="dom-if"
            if="{{_isset(newProduct)}}">

                <template is="dom-repeat" items="{{data}}" as="datum">
                    <tr class="alternate">
                        <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                            <td data-id="{{_getCol(datum,idRow)}}"
                                class$="table__{{col}}__class"
                                style$="text-align:{{_isCurrency(col)}};">
                                <template is="dom-if" if="{{!_isEditable(col)}}">
                                    {{_getCol(datum,col)}}
                                </template>
        <template is="dom-if"
            if="{{_isEditable(col)}}">
                                    <input style$="text-align:{{_isNumber(col)}}" size=4 class$="table__{{col}}__class"
                                           data-bill-id='{{_getCol(datum,"BillId.Id")}}' name="{{_filterColName(col)}}"
                                           value="{{_getCol(datum,col)}}" on-focusout="_editRequest"
                                           data-id="{{_getCol(datum,idRow)}}">
                                    <iron-ajax auto
                                               content-type="application/json"
                                               url="{{_getUpdateUrl(datum)}}"
                                               method="PUT"
                                               on-response="_onRefresh"></iron-ajax>
                                </template>

        </td>

        </template>
        <td>
            <paper-button tabindex="-1"
                data-id="{{datum.Id}}"
                on-click="_deleteRequest">Delete
            </paper-button>
        </td>
        </tr>
        </template>
        </template>

        <template is="dom-if"
            if="{{!_isset(newProduct)}}">

                <template is="dom-repeat" items="{{productList}}" as="datum">
                    <tr class="alternate">
                        <td>{{datum.ProductCode}}</td>
                        <td>{{datum.Name}}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="delete-button"></td>
                    </tr>
                </template>
        <template is="dom-repeat"
            items="{{inventoryList}}"
            as="datum">
                    <tr class="alternate">
                        <td></td>
                        <td>{{datum.BatchNo}}</td>
                        <td>{{_computeCurrency(datum.InventoryScale.0.Price)}}</td>
                        <td>{{datum.InventoryScale.0.Units}}</td>
                        <td></td>
                        <td></td>
                        <td class="delete-button"></td>
                    </tr>
                </template>
        </template>

    </tbody>
    </table>
    </template>

    <script>
        Polymer({

            is: 'product-data-table',
            properties: {
                url: {
                    type: String,
                    reflectToAttribute: true,
                },
                loading: {
                    type: Boolean,
                    value: true
                },
                quantityInternal: {
                    type: Number,
                    value: 0,
                },
                quantity: {
                    type: Number,
                    value: 0,
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_clearQuantity'
                },
                quantityFocus: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    notify: true,
                    observer: '_quantityWatcher'
                },

                target: {
                    type: Object,
                    value: function() {
                        return document.body;
                    }
                },
                newProduct: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                },
                productIn: {
                    type: Object,
                    reflectToAttribute: true
                },
                billId: {
                    type: Object,
                    reflectToAttribute: true,
                },
                data: {
                    type: Object,
                },
                editable: {
                    type: Object,
                },
                productList: {
                    type: Object,
                },
                inventoryList: {
                    type: Object,

                },
                cols: {
                    type: Object,
                    reflectToAttribute: true
                },
                editUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                deleteUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                postUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                refresh: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    notify: true,
                    observer: "_refreshMain"
                },
                idRow: {
                    type: String,
                    reflectToAttribute: true
                }
            },

            _refreshMain: function() {
                if (this.refresh)
                    this.refresh = false;
            },
            _onRefresh: function() {
                this.refresh = true;
            },
            ready: function() {},
            _setQuantity: function() {
                this.quantity = this.quantityInternal;
            },
            onRandom: function(event) {
                key = event.detail.keyboardEvent.key;

                this.$.product_identifier.focus();
            },

            onEnter: function() {
                this.$.product_identifier.focus();
            },
            _quantityWatcher: function() {
                this.$.product_identifier.focus();
                if (this.quantityFocus) {
                    this.quantityInternal = "";
                    this.$.quantity_input.focus();
                }

            },

            _getColName: function(col) {
                return this.cols[col];
            },
            _getCols: function(cols) {
                return Object.keys(cols);
            },
            _filterColName: function(col) {
                return col.split("__")[0];
            },
            _isEditable: function(col) {
                return this.editable.indexOf(col.split("__")[0]) > 0;
            },
            _add: function(val1, val2) {
                return parseInt(val1) + parseInt(val2);
            },
            _isNumber: function(col) {
                if (col.split("__").includes("number"))
                    return "right";
            },
            _isCurrency: function(col) {
                if (col.split("__").includes("currency"))
                    return "right";
            },
            _getCol: function(datum, col) {
                formats = col.split("__");
                col = formats[0]
                formats = formats.slice(1)
                search = ["currency"];
                for (i = 0; i <= formats.length; i++) {
                    format = formats[i];
                    switch (format) {
                        case "currency":
                            {
                                return parseFloat(eval('datum.' + col)).toFixed(2);
                                break;
                            }
                    }
                }


                return eval('datum.' + col);
            },

            _editRequest: function(event) {
                id = event.target.dataId;
                params = {};
                params[event.target.name] = event.target.value;
                if (!isNaN(event.target.value)) {
                    params[event.target.name] = parseFloat(event.target.value);
                }
                if (this.postUrl) {
                    postUrl = this.postUrl.replace(":id:", id);
                    this.$.editRequest.url = postUrl;
                    this.$.editRequest.body = params;
                    this.$.editRequest.generateRequest();
                }
                sleep(200);
                this.$.mainRequest.generateRequest();
                this.refresh = true;
            },

            _deleteRequest: function(event) {
                id = event.target.dataId;
                if (this.deletePage) {

                } else if (this.deleteUrl) {

                    deleteUrl = this.deleteUrl.replace(":id:", id);
                    this.$.deleteRequest.url = deleteUrl;
                    this.$.deleteRequest.generateRequest();
                    sleep(200);
                    this.$.mainRequest.generateRequest();
                }
                this.refresh = true;

            },
            deletableLink: function(datum) {
                if (this.deleteUrl)
                    return this.deleteUrl.replace(":id:", eval('datum.' + this.idRow));
            },
            _getUpdateUrl: function(datum) {
                return "/v1/sales/" + datum.Id;
            },

            _computeCurrency: function(x) {
                return parseFloat(x).toFixed(2);
            },
            _isset: function(value) {

                return value === "";
            },

        });
    </script>

</dom-module>
