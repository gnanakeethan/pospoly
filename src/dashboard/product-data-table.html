<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<dom-module id="product-data-table">

    <template>
        <style>
            :host {
                display: block;
                clear: both;
                float: none;
            }

            table {
                width: 100%;
                border-spacing: 0px;
                border-collapse: seperate;
            }

            table.card {
                background: white;
                @apply(--shadow-elevation-2dp);
                border-radius: 2px;
            }

            th {
                font-size: 12px;
                color: rgba(0, 0, 0, .54);
                padding:12px;
                padding-left:20px;
                @apply(--paper-font-common-base);
                @apply(--paper-font-common-nowrap);
                font-weight: 500;
            }

            tr {
                height:35px;
                vertical-align:middle;
            }

            td {
                font-size: 13px;
                font-weight: normal;
                color: rgba(0, 0, 0, .87);
                padding-left:12px;
                padding-right:12px;
                padding-top:5px;
                border-top: 1px solid var(--paper-datatable-divider-color, --divider-color);
            }

            tr:hover td {
                background: #ddd;
            }

        </style>

        <iron-ajax
            id="mainRequest"
            auto url="{{url}}"
            last-response="{{data}}"></iron-ajax>

        <iron-ajax id="deleteRequest" method="DELETE"></iron-ajax>
        <iron-ajax content-type="application/json" id="editRequest" method="PUT" last-response="{{editResult}}"></iron-ajax> 




        <table>
            <thead>
                <tr>
                    <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                        <th id="sortables" data-column="{{col}}" on-click="_sortToggle">{{_getColName(col)}}</th>
                    </template>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <template is="dom-repeat" items="{{data}}" as="datum">
                    <tr>
                        <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                            <td on-dblclick="_deleteRequest"
                                data-id="{{_getCol(datum,idRow)}}">                            
                                <template is="dom-if" if="{{!_isEditable(col)}}">
                                    {{_getCol(datum,col)}}
                                </template>
                                <template is="dom-if" if="{{_isEditable(col)}}">
                                    <input type="number" data-bill-id='{{_getCol(datum,"BillId.Id")}}' name="{{col}}" value="{{_getCol(datum,col)}}" on-focusout="_editRequest" data-id="{{_getCol(datum,idRow)}}">
                                    <iron-ajax content-type="application/json" auto url="{{_getUpdateUrl(datum)}}" method="PUT" on-response="_refreshMain"></iron-ajax> 
                                </template>

                            </td>
                            </paper-button>

                        </template>

                    </tr>
                </template>
            </tbody>
        </table>
    </template>

    <script>

        Polymer({

            is: 'product-data-table',
            properties: {
                url: {
                    type: String,
                    reflectToAttribute: true
                },
                billId:{
                    type:Object,
                    reflectToAttribute:true,
                },
                data: {
                    type: Object,
                },
                editable:{
                    type:Object,
                },
                productList:{
                    type:Object,
                },
                cols: {
                    type: Object,
                    reflectToAttribute: true
                },
                editUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                deleteUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                postUrl: {
                    type: String,
                    reflectToAttribute: true
                },
                refresh:{
                    type:Boolean,
                    reflectToAttribute:true,
                    observer:'_refreshMain'
                },
                idRow: {
                    type: String,
                    reflectToAttribute: true
                }
            },
            _refreshMain:function(){
                this.$.mainRequest.generateRequest();
                this.refresh = false;
            },
            ready: function () {
            },
            _getColName: function (col) {
                return this.cols[col];
            },
            _getCols: function (cols) {
                return Object.keys(cols);
            },
            _isEditable:function(col){
                return this.editable.indexOf(col)>0;
            },
            _add: function (val1, val2) {
                return parseInt(val1) + parseInt(val2);
            },
            _getCol: function (datum, col) {
                return eval('datum.' + col);
            },
            _editRequest: function (event) {
                id = event.target.dataId;
                params = {};
                params[event.target.name] = event.target.value;
                if(!isNaN(event.target.value)){
                    params[event.target.name] = parseFloat(event.target.value);
                }
                if (this.postUrl) {
                    postUrl = this.postUrl.replace(":id:", id);
                    this.$.editRequest.url = postUrl;
                    this.$.editRequest.body = params;
                    this.$.editRequest.generateRequest();
                    sleep(300);
                    this.$.mainRequest.generateRequest();
                }

            },

            _deleteRequest: function (event) {
                id = event.target.dataId;
                if (this.deletePage) {

                }
                else if (this.deleteUrl) {
                    deleteUrl = this.deleteUrl.replace(":id:", id);
                    this.$.deleteRequest.url = deleteUrl;
                    this.$.deleteRequest.generateRequest();
                    this.$.mainRequest.generateRequest();
                    this.$.mainRequest.generateRequest();
                }
                console.log(deleteUrl);

            },
            deletableLink: function (datum) {
                if (this.deleteUrl)
                    return this.deleteUrl.replace(":id:", eval('datum.' + this.idRow));
            },
            _getUpdateUrl:function(datum){
                return "/v1/sales/"+datum.Id;
            },
        });

    </script>

</dom-module>
