<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="product-data-table">

    <template>
        <style>
            :host {
                display: block;
                clear: both;
                float: none;
            }

            table {
                width: 100%;
                border-spacing: 0px;
                border-collapse: seperate;
            }

            table.card {
                background: white;
                @apply(--shadow-elevation-2dp);
                border-radius: 2px;
            }

            th {
                font-size: 12px;
                color: rgba(0, 0, 0, .54);
                padding:12px;
                padding-left:20px;
                @apply(--paper-font-common-base);
                @apply(--paper-font-common-nowrap);
                font-weight: 500;
            }

            tr {
                height: 48px;
            }

            td {
                font-size: 13px;
                font-weight: normal;
                color: rgba(0, 0, 0, .87);
                padding:12px;
                border-top: 1px solid var(--paper-datatable-divider-color, --divider-color);
            }

            tr:hover td {
                background: #ddd;
            }

        </style>

        <iron-ajax
            id="mainRequest"
            auto url="{{url}}"
            last-response="{{data}}"></iron-ajax>

        <iron-ajax id="deleteRequest" method="DELETE"></iron-ajax>
        <iron-ajax content-type="application/json" id="editRequest" method="PUT" last-response="{{editResult}}"></iron-ajax> 
        <iron-ajax content-type="application/json" id="createRequest" method="POST" last-response="{{createResult}}"></iron-ajax> 




        <table>
            <thead>
                <tr>
                    <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                        <th id="sortables" data-column="{{col}}" on-click="_sortToggle">{{_getColName(col)}}</th>
                    </template>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <template is="dom-if" if="{{!data}}">
                    <tr>
                        <b>No Rows to Show</b>
                    </tr>
                </template>
                <template is="dom-repeat" items="{{data}}" as="datum">
                    <tr>
                        <template is="dom-repeat" items="{{_getCols(cols)}}" as="col">
                            <td>                            
                                <template is="dom-if" if="{{!_isEditable(col)}}">
                                    {{_getCol(datum,col)}}
                                </template>
                                <template is="dom-if" if="{{_isEditable(col)}}">
                                    <input data-bill-id='{{_getCol(datum,"BillId.Id")}}' name="{{col}}" value="{{_getCol(datum,col)}}" on-change="_editRequest" data-id="{{_getCol(datum,idRow)}}">
                                    <iron-ajax content-type="application/json" auto url="{{_getUpdateUrl(datum)}}" method="PUT" on-response="_refreshMain"></iron-ajax> 
                                </template>
                            </td>
                        </template>
                        <td>

                            <paper-button style="background:red;color:white;" on-click="_deleteRequest"
                                data-id="{{_getCol(datum,idRow)}}">DELETE
                            </paper-button>
                        </td>
                    </tr>
                </template>
                <tr>
                    <td>
                        <input id="product_identifier" value="{{productIdentifier}}"
                        on-keyup="_searchInput"
                        autofocus>
                        <iron-ajax url="/v1/products?{{searchInput}}"
                            auto
                            debounce-duration="100"
                            on-response="_singleProduct"
                            last-response="{{productList}}">
                        </iron-ajax>
                        <iron-ajax auto id="inventoryRequest" url="/v1/inventories?query=ProductId:{{productList.0.Id}}" last-response="{{inventoryList}}">
                        </iron-ajax>
                    </td>

                </tr>
                <template is="dom-repeat" items="{{productList}}" as="datum">
                    <tr>
                        <td on-click="selectProduct">
                            {{datum.Name}}
                        </td>
                    </tr>
                </template>
                <template is="dom-if" if="{{_singleProduct(productList)}}">
                    <template is="dom-repeat" items="{{inventoryList}}" as="inventory">
                        <tr>
                            <td>{{inventory.BatchNo}}</td>
                            <td>{{inventory.Id}}</td>
                                <td>
                                    <template is="dom-repeat" items="{{inventory.InventoryScale}}" as="scale">
                                        {{scale.Units}}@{{scale.Price}}
                                    </template>
                                    <td><paper-button on-click="_putRecord" data-id="{{inventory.Id}}">Select</paper-button></td>
                                </tr>
                            </template>
                        </template>

                    </tbody>
                </table>
            </template>

            <script>

                Polymer({

                    is: 'product-data-table',
                    properties: {
                        url: {
                            type: String,
                            reflectToAttribute: true
                        },
                        billId:{
                            type:Object,
                            reflectToAttribute:true,
                        },
                        data: {
                            type: Object,
                        },
                        editable:{
                            type:Object,
                        },
                        productList:{
                            type:Object,
                        },

                        productIdentifier:{
                            type:String,
                        },
                        cols: {
                            type: Object,
                            reflectToAttribute: true
                        },
                        editUrl: {
                            type: String,
                            reflectToAttribute: true
                        },
                        deleteUrl: {
                            type: String,
                            reflectToAttribute: true
                        },
                        postUrl: {
                            type: String,
                            reflectToAttribute: true
                        },

                        idRow: {
                            type: String,
                            reflectToAttribute: true
                        }

                    },

                    _singleProduct:function(productList){
                        if(productList.length===1){
                            this.$.inventoryRequest.generateRequest();
                            return true;
                        }
                        return false;
                    },
                    _putRecord:function(event){
                        if(this.productList.length==1){
                            id = this.billId;
                            invId = event.target.dataId;
                            console.log(invId);
                            params = {};
                            params["InventoryId"] = {};
                            params["InventoryId"]["Id"] = invId;
                            params["BillId"]= {};
                            params["BillId"]["Id"] = id.Id;
                            params["Units"]=1.000;
                            params["Discount"] = 0.0;
                            if (this.postUrl) {
                                postUrl = this.postUrl.replace(":id:/",'');
                                console.log(postUrl);
                                this.$.createRequest.url = postUrl;
                                this.$.createRequest.body = params;
                                this.$.createRequest.generateRequest();
                                sleep(300);
                                this.$.mainRequest.generateRequest();
                            }
                        }
                    },
                    _refreshMain:function(){
                                this.$.mainRequest.generateRequest();
                    },

                    _searchInput:function(){
                        input = this.$.product_identifier.value;
                        console.log(input)
                        if (!isNaN(input)) {
                            this.searchInput = "query=Barcode:" + input;
                        }
                        else {
                            this.searchInput = "query=Name:" + input;
                        }
                    },
                    ready: function () {
                    },
                    _getColName: function (col) {
                        return this.cols[col];
                    },
                    _getCols: function (cols) {
                        return Object.keys(cols);
                    },
                    _isEditable:function(col){
                        return this.editable.indexOf(col)>0;
                    },
                    _add: function (val1, val2) {
                        return parseInt(val1) + parseInt(val2);
                    },
                    _getCol: function (datum, col) {
                        return eval('datum.' + col);
                    },
                    _editRequest: function (event) {
                        id = event.target.dataId;
                        params = {};
                        params[event.target.name] = event.target.value;
                        if(!isNaN(event.target.value)){
                            params[event.target.name] = parseFloat(event.target.value);
                        }
                        if (this.postUrl) {
                            postUrl = this.postUrl.replace(":id:", id);
                            this.$.editRequest.url = postUrl;
                            this.$.editRequest.body = params;
                            this.$.editRequest.generateRequest();
                            sleep(300);
                            this.$.mainRequest.generateRequest();
                        }

                    },

                    _deleteRequest: function (event) {
                        id = event.target.dataId;
                        if (this.deletePage) {

                        }
                        else if (this.deleteUrl) {
                            deleteUrl = this.deleteUrl.replace(":id:", id);
                            this.$.deleteRequest.url = deleteUrl;
                            this.$.deleteRequest.generateRequest();
                            this.$.mainRequest.generateRequest();
                            this.$.mainRequest.generateRequest();
                        }
                        console.log(deleteUrl);

                    },
                    deletableLink: function (datum) {
                        if (this.deleteUrl)
                            return this.deleteUrl.replace(":id:", eval('datum.' + this.idRow));
                    },
                    _getUpdateUrl:function(datum){
                        return "/v1/sales/"+datum.Id;
                    },
                });

            </script>

        </dom-module>
